# Retrofit
<a name="up"></a>

---

## Задача №3. Передай водичку*

Немного усложним задачу. Каждый воркер будет пытаться записать в переменную своё значение. При этом делают они это синхронно.

```kotlin
sealed interface WaterBottle {
    data object Karachinskaya : WaterBottle
    data object Borjomi : WaterBottle
}

fun main() {
    var bottle: WaterBottle? = null

    val firstWorker = thread {
        synchronized(WaterBottle.Karachinskaya) {
            Thread.sleep(1_000)
            synchronized(WaterBottle.Borjomi) {
                bottle = WaterBottle.Karachinskaya
            }
        }
    }

    val secondWorker = thread {
        synchronized(WaterBottle.Borjomi) {
            Thread.sleep(1_000)
            synchronized(WaterBottle.Karachinskaya) {
                bottle = WaterBottle.Borjomi
            }
        }
    }

    firstWorker.join()
    secondWorker.join()

    println(bottle)
}
```

Объясните своими словами почему приложение зависает.

---

## Ответ

Данные потоки блокируют друг друга.
Один из потоков ожидает ресурсы, которые находятся в использовании у противоположного потока.
(Ну или у любого возможного другого потока, если их больше 2-х).
Происходит `Deadlock`.

При выполнении кода происходит синхронизация `Карачинской` и `Боржоми`.
Первый поток захватывает ресурсы `Карачинская`, а в это время второй поток захватывает ресурсы `Боржоми`.
Каждый ждет секунду.
А потом, каждый поток пытается захватить ресурс, который уже занят противоположным потоком.
То есть, первый поток не может продолжить свое выполнение (а значит и освободить занятые им ресурсы), потому что ждет, пока второй поток отдаст ему необходимые ресурсы.
Но и второй поток не может выполнить (а значит снова освободить занятые им ресурсы), тем самым отдать нужные ресурсы первому потоку он не может, потому что для его выполнения ожидает ресурсы, занятые как раз первым потоком.
В общем они сидят друг напротив друга и ждут, пока кто-то из них отдаст используемые ресурсы, но отдавать никто не собирается.
Так и прождут, пока вычислительная машина не сгорит :)

---

### [TASK_2](Task_2.md) [UP](#up)
